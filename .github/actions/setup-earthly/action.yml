name: "Setup Earthly"
description: "Configure AWS Credentials and Earthly remote runner"

inputs:
  aws_role_arn:
    description: "The AWS Role ARN"
    required: true
  aws_region:
    description: "The AWS Region"
    required: true

runs:
  using: "composite"
  steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ inputs.aws_role_arn }}
        aws-region: ${{ inputs.aws_region }}
    - name: Configure Earthly remote runner
      run: |
        mkdir -p /tmp/certs

        # Fetch TLS certs from AWS Secrets Manager
        JSON=$(aws secretsmanager get-secret-value --secret-id global/ci/ci-tls --query SecretString --output text)
        echo "${JSON}" | jq -r .private_key | sed 's/\\n/\n/g' > /tmp/certs/key.pem
        echo "${JSON}" | jq -r .certificate | sed 's/\\n/\n/g' > /tmp/certs/cert.pem
        echo "${JSON}" | jq -r .ca_certificate | sed 's/\\n/\n/g' > /tmp/certs/ca.pem

        # Configure Earthly
        earthly config global.tlskey /tmp/certs/key.pem
        earthly config global.tlscert /tmp/certs/cert.pem
        earthly config global.tlsca /tmp/certs/ca.pem
      shell: bash
